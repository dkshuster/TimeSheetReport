<!DOCTYPE html>
<html>
<head>
    <title>timesheet_app</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",timeStore:void 0,timeGrid:void 0,week2Start:void 0,myStore:void 0,launch:function(){console.log("Sum of time Entries by User/Task and week"),this.pulldownContainer=Ext.create("Ext.container.Container",{id:"pulldown-container-id",layout:{type:"hbox",align:"stretch"}}),this.add(this.pulldownContainer),this._loadIterations()},_loadIterations:function(){this.iterComboBox=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Select Iteration",labelAlign:"right",width:300,listeners:{ready:function(){this._loadData()},select:function(){this._loadData()},scope:this}}),this.pulldownContainer.add(this.iterComboBox)},_loadData:function(){var e=this.iterComboBox.getRecord().get("StartDate"),t=Rally.util.DateTime.toIsoString(e).replace(/T.*$/,"T00:00:00.000Z"),a=this.iterComboBox.getRecord().get("EndDate"),r=Rally.util.DateTime.toIsoString(a).replace(/T.*$/,"T00:00:00.000Z"),i=Rally.util.DateTime.add(new Date(e),"day",7);this.week2Start=Rally.util.DateTime.toIsoString(i).replace(/T.*$/,"T00:00:00.000Z"),this.week2Start=new Date(this.week2Start).getTime();var o=Ext.create("Rally.data.QueryFilter",{property:"WeekStartDate",operator:">=",value:t});o.toString();var s=Ext.create("Rally.data.QueryFilter",{property:"WeekStartDate",operator:"<",value:r});s.toString(),this.timeStore?(this.timeStore.setFilter([o,s]),this.timeStore.load()):this.timeStore=Ext.create("Rally.data.wsapi.Store",{model:"TimeEntryItem",pageSize:100,autoLoad:!0,filters:[o,s],listeners:{load:this._onTimeEntryItemLoaded,scope:this},fetch:["Task","TimeSpent","FormattedID","User","Values","WeekStartDate","ClarityProject"]})},_onTimeEntryItemLoaded:function(e,t){var a=[],r=t.length;Ext.Array.each(t,function(e){var t={key:e.get("User")._refObjectName+e.get("Task").FormattedID+e.get("Task").c_ClarityProject,User:e.get("User")._refObjectName,ClarityProject:e.get("Task").c_ClarityProject,FormattedID:e.get("Task").FormattedID,Task:e.get("Task")._refObjectName,Week1:0,Week2:0,Values:[],TimeSpent:e.get("Task").TimeSpent,WeekStartDate:e.data.WeekStartDate};e.getCollection("Values").load({fetch:["Hours","DateVal"],callback:function(e){Ext.Array.each(e,function(e){t.Values.push({Hours:e.get("Hours"),DateVal:e.get("DateVal")})},this),0===--r&&this._createGrid(a)},scope:this}),a.push(t)},this),this._createGrid(a)},_createGrid:function(e){var t=0,a=0,r=0,i=[];Ext.Array.each(e,function(e){var o={key:e.key,User:e.User,GroupData:e.User+"  "+e.ClarityProject,ClarityProject:e.ClarityProject,FormattedID:e.FormattedID,Task:e.Task,Week1:0,Week2:0,TimeSpent:e.TimeSpent};e.Values.length>0&&(Ext.Array.each(e.Values,function(e){t+=e.Hours},this),new Date(e.WeekStartDate).getTime()>=this.week2Start?r=t:a=t);var s=i.findIndex(t=>t.key===e.key);s>-1?(i[s].Week1+=a,i[s].Week2+=r):(a>0||r>0)&&(o.Week1+=a,o.Week2+=r,i.push(o)),a=0,r=0,t=0},this),this.myStore=Ext.create("Rally.data.custom.Store",{data:i,groupField:"GroupData",pageSize:100,autoload:!0},this),this.grid?this.grid.reconfigure(this.myStore):(console.log("create grid"),this.grid=Ext.create("Rally.ui.grid.Grid",{store:this.myStore,features:[{ftype:"groupingsummary"}],showRowActionsColumn:!1,columnCfgs:[{text:"User",dataIndex:"User",summaryRenderer:function(){return"Totals:"}},{text:"Clarity Project",dataIndex:"ClarityProject"},{text:"Task ID",dataIndex:"FormattedID"},{text:"Task",dataIndex:"Task"},{text:"Week 1",dataIndex:"Week1",summaryType:"sum"},{text:"Week 2",dataIndex:"Week2",summaryType:"sum"},{text:"Time Spent",dataIndex:"TimeSpent",summaryType:"sum"}]}),this.add(this.grid))}});

            Rally.launchApp('CustomApp', {
                name:"timesheet_app",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
